{% extends 'base.html' %}
{% block title %}Base de Conhecimento{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h2>Base de Conhecimento</h2>
  {% if current_user.role in ['admin','supervisor','tech'] %}
  <a class="btn btn-primary" href="{{ url_for('kb.create') }}">Novo Artigo</a>
  {% endif %}
</div>
<div class="mt-3">
  <form class="input-group" action="{{ url_for('kb.index') }}" method="get" onsubmit="return false;">
    <input id="kb-search" type="search" class="form-control" placeholder="Pesquisar artigos...">
    <button class="btn btn-outline-secondary" type="button" onclick="kbSearch()">Buscar</button>
  </form>
</div>
<ul id="kb-results" class="list-group mt-3"></ul>
<hr>
<div class="list-group">
  {% for a in articles %}
  <a class="list-group-item list-group-item-action" href="{{ url_for('kb.view', article_id=a.id) }}">
    <div class="d-flex justify-content-between"><strong>{{ a.title }}</strong> <small>{{ a.updated_at|localtime }}</small></div>
    <div class="text-muted small">{{ 'Público' if a.public else 'Interno' }} • {{ a.status }}</div>
  </a>
  {% else %}
  <div class="list-group-item text-muted">Sem artigos.</div>
  {% endfor %}
</div>
<script>
function kbSearch(){
  const q = document.getElementById('kb-search').value.trim();
  if(!q){ document.getElementById('kb-results').innerHTML=''; return; }
  fetch(`{{ url_for('kb.search') }}?q=${encodeURIComponent(q)}`)
    .then(r=>r.json())
    .then(items=>{
      const ul = document.getElementById('kb-results');
      ul.innerHTML = items.map(i=>`<li class='list-group-item'><a href='${i.url}'>${i.title}</a></li>`).join('') || "<li class='list-group-item text-muted'>Sem resultados.</li>";
    });
}
</script>
{% endblock %}
