{% extends 'base.html' %}
{% block title %}Chat{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Seus chamados</h5>
        <div class="list-group list-group-flush">
          {% for t in tickets %}
          <a href="{{ url_for('chat.index', ticket_id=t.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between{% if active and t.id == active.id %} active{% endif %}">
            <span>{{ t.number }}</span>
            <small>{{ t.status }}</small>
          </a>
          {% else %}
          <div class="text-muted">Sem chamados.</div>
          {% endfor %}
        </div>
        <hr>
        <form method="post" action="{{ url_for('chat.send') }}">
          <div class="mb-2"><textarea class="form-control" name="content" rows="2" placeholder="Novo chamado pelo chat..."></textarea></div>
          <button class="btn btn-sm btn-primary" type="submit">Criar</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card h-100">
      <div class="card-body d-flex flex-column">
        {% if active %}
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{{ active.title }}</h5>
          <span class="badge text-bg-secondary">{{ active.number }}</span>
        </div>
        <div class="text-muted">Status: {{ active.status }} • Prioridade: {{ active.priority }}</div>
        <hr>
        <div class="flex-grow-1" style="overflow:auto; max-height: 50vh;">
          <div id="chatThread" class="list-group list-group-flush" data-ticket-id="{{ active.id }}">
            {% for c in comments %}
            <div class="list-group-item" data-comment-id="{{ c.id }}">
              <div class="small text-muted d-flex justify-content-between">
                <span>
                  {{ c.user.name }}
                  {% if c.internal %}<span class="badge bg-secondary ms-2">Interno</span>{% endif %}
                </span>
                <span>{{ c.created_at|localtime }}</span>
              </div>
              <div style="white-space: pre-wrap;">{{ c.content }}</div>
            </div>
            {% else %}
            <div class="list-group-item text-muted">Sem mensagens.</div>
            {% endfor %}
          </div>
        </div>
        <hr>
        {% if active.status != 'Fechado' and (current_user.role == 'client' or current_user.role in ['admin','supervisor'] or not active.assigned_to_id or active.assigned_to_id == current_user.id) %}
        <form method="post" action="{{ url_for('chat.send') }}" class="d-flex gap-2 align-items-start">
          <input type="hidden" name="ticket_id" value="{{ active.id }}">
          <div class="flex-grow-1">
            <textarea class="form-control" name="content" rows="2" placeholder="Escreva uma mensagem..."></textarea>
            {% if current_user.role in ['admin','supervisor','tech'] %}
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="internalMsg" name="internal" value="1">
              <label class="form-check-label" for="internalMsg">Mensagem interna (somente equipe)</label>
            </div>
            {% endif %}
          </div>
          <button class="btn btn-primary" type="submit">Enviar</button>
        </form>
        {% else %}
        <div class="alert alert-light border d-flex justify-content-between align-items-center">
          <div>
            {% if active.status == 'Fechado' %}
              Este chamado está <strong>encerrado</strong>. Para voltar a interagir, um técnico deve reabrir.
            {% else %}
              {% if current_user.role in ['tech'] and active.assigned_to_id and active.assigned_to_id != current_user.id %}
                Este chamado está sendo atendido por outro técnico. Solicite transferência ou convite.
              {% else %}
                Interação indisponível.
              {% endif %}
            {% endif %}
          </div>
          {% if current_user.role != 'client' %}
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('tickets.detail', ticket_id=active.id) }}">Abrir detalhes</a>
          {% endif %}
        </div>
        {% endif %}
        {% else %}
        <div class="text-muted">Selecione um chamado na lista à esquerda.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
